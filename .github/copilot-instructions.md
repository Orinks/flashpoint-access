# Cyber Knights: Flashpoint Accessibility Mod - AI Agent Guide

## Project Overview
MelonLoader mod that adds screen reader accessibility to Cyber Knights: Flashpoint (Unity IL2CPP game) using SRAL library and Harmony runtime patching.

**Status**: Fully functional mod that announces UI elements via screen reader (NVDA, JAWS, SAPI, UIA).

## Critical Architecture

### Mod Loading Flow
1. **MelonLoader** loads `CKFlashpointAccessibility.dll` from `Mods/` folder
2. `Plugin.cs::OnInitializeMelon()` initializes SRAL via P/Invoke to native `SRAL.dll`
3. `OnSceneWasLoaded()` detects first scene load, triggers Harmony patching
4. `UIPatches.ApplyPatches()` uses **runtime type resolution** via `AccessTools` to find IL2CPP game types
5. Harmony patches intercept Unity UI events (`OnSelect`, `OnPointerClick`, `SetText`, etc.)
6. Patches call `SRALHelper.Speak()` to announce UI text via screen reader

### IL2CPP Interop Strategy
- Game assemblies are **IL2CPP** (not Mono), generated by MelonLoader on first launch
- **No compile-time references** to game types - use `AccessTools.Method()` and reflection
- IL2CPP types live in `Il2CppRPG.UI.*` namespace (see `dumped/dump.cs` for full class tree)
- Text extraction uses reflection to access private fields (`_Text`, `_SubText`) in STETextBlock components

### SRAL Integration
- `SRAL.cs`: C# P/Invoke wrapper for native C++ SRAL.dll (Screen Reader Abstraction Library)
- Initialization tries engines in order: NVDA → SAPI → UIA (whichever is available)
- `SRAL_Output()` handles both speech and braille displays simultaneously
- Rate limiting prevents announcement spam (100ms default delay between calls)

## Key Files & Responsibilities

| File | Purpose | Edit When |
|------|---------|-----------|
| `Plugin.cs` | MelonMod entry point, SRAL initialization, config system | Adding features, changing initialization |
| `Patches/UIPatches.cs` | All Harmony patches for UI classes | Adding new UI element support |
| `SRAL.cs` | P/Invoke definitions (DO NOT EDIT unless SRAL API changes) | Never touch unless updating SRAL version |
| `CKFlashpointAccessibility.csproj` | References to MelonLoader + game assemblies | After game updates |
| `scripts/deploy-mod.ps1` | Build + copy to `Mods/` folder | Deployment logic changes |

## Development Workflows

### Testing a Change
```powershell
.\scripts\deploy-mod.ps1  # Builds + deploys automatically
# Launch game via Steam, check MelonLoader\Latest.log
```

### Adding New UI Patches
1. Search `dumped/dump.cs` or `UI-CLASSES-TO-PATCH.md` for target class
2. Add patch method to `UIPatches.cs` (use `Postfix` for announcements)
3. Call `PatchType()` in `ApplyPatches()` with runtime type name
4. Extract text using `GetButtonText()` or `GetWidgetText()` helper
5. Announce via `SRALHelper.Speak(text, interrupt: true)`

**Example Pattern**:
```csharp
public static void STEButton_OnSelect_Postfix(object __instance, BaseEventData eventData) {
    if (!CKAccessibilityMod.AnnounceButtons) return;
    string text = GetButtonText(__instance);
    if (!string.IsNullOrEmpty(text)) {
        SRALHelper.Speak(text, true);
    }
}
```

### Debugging IL2CPP Types
- **Check if type exists**: Search `dumped/dump.cs` for class name
- **View type at runtime**: MelonLogger shows "Type not found" if runtime resolution fails
- **Inspect assemblies**: Use dnSpy on `MelonLoader\Il2CppAssemblies\Assembly-CSharp.dll`
- **Test patches**: Watch `MelonLoader\Latest.log` for "Patched: ClassName.MethodName" confirmations

### Text Extraction Strategy (Critical!)
Game uses custom `STETextBlock` components, not standard Unity Text/TMP. Extraction priority:
1. Reflect into `_Text` field → get `STETextBlock` → access `.text` property
2. Try `_SubText` field (secondary text)
3. Search children for TextMeshPro components
4. Fallback to GameObject name (cleaned up for speech)

## Project Conventions

### Patching Rules
- **Prefer `OnSelect` over `OnPointerEnter`** - keyboard navigation, not mouse hover
- **Always check config** - `if (!CKAccessibilityMod.AnnounceButtons) return;`
- **Use `interrupt: true` for selections** - immediate feedback required
- **Use `interrupt: false` for text updates** - allow reading to complete
- **Never patch in tight loops** - rate limiting is essential

### Configuration System (MelonPreferences)
Settings stored in `UserData/MelonPreferences.cfg`:
- `Enabled`: Master toggle
- `AnnounceButtons`, `AnnounceMenuItems`: Feature toggles
- `SpeechDelay`: Rate limiting (100ms default)
- `InterruptSpeech`: Whether new speech cancels current

### Logging Discipline
- **MelonLogger.Msg()** for successful operations
- **MelonLogger.Warning()** for non-critical issues (missing types)
- **MelonLogger.Error()** for failures that break functionality
- Prefix accessibility logs with `[Accessibility]` for grep-ability

## External Dependencies

### Build-Time (Game Installation Required)
- `MelonLoader.dll` - Mod loader framework (in `MelonLoader\net6\`)
- `0Harmony.dll` - Runtime patching (bundled with MelonLoader)
- `Il2CppInterop.Runtime.dll` - IL2CPP type interop
- Game assemblies from `MelonLoader\Il2CppAssemblies\`

### Runtime (Must be in Mods/)
- `SRAL.dll` - Native C++ library (build from `tools\SRAL\`)
- `nvdaControllerClient64.dll` - NVDA direct support (optional)

### Building SRAL (if missing)
```powershell
cd tools\SRAL
cmake . -B build -A x64
cmake --build build --config Release
Copy-Item "build\Release\SRAL.dll" -Destination "..\..\CKFlashpointAccessibility\bin\Debug\net6.0\"
```

## Common Issues & Solutions

### "Type not found: Il2CppRPG.UI.*"
Game assemblies not loaded yet. Patches only apply in `OnSceneWasLoaded()` after scene 0/1 loads.

### Text extraction returns empty string
STETextBlock uses private fields. Check reflection binding flags include `NonPublic | Instance`.

### No speech output
1. Check SRAL initialization in log ("SRAL initialized with engine: X")
2. Verify screen reader is running (NVDA/JAWS/Narrator)
3. Confirm `SRAL.dll` is in Mods folder

### Duplicate announcements
Multiple patches firing for same event. Remove patches on base classes if derived classes are patched.

### Build fails with missing references
Run `.\scripts\update-references.ps1` after game updates or first install.

## Testing Checklist
- [ ] Mod loads without errors (check Latest.log)
- [ ] Tab key navigation announces button text
- [ ] Arrow keys navigate lists with announcements
- [ ] Screen transitions are spoken
- [ ] Dialog options announce on selection
- [ ] No performance degradation
- [ ] Config toggles work (test `Enabled = false`)

## Critical Context Files
- `IMPLEMENTATION-NOTES.md` - Detailed patch strategy and technical decisions
- `UI-CLASSES-TO-PATCH.md` - Full IL2CPP UI class hierarchy from dump
- `TESTING-GUIDE.md` - User-facing testing instructions
- `dumped/dump.cs` - 861K line IL2CPP class dump (search before patching new types)

## Screen Reader Accessibility Notes
- **Focus-based, not hover-based** - blind users navigate via Tab/Arrows, not mouse
- **Interruptible speech** - selections must stop previous announcements for responsiveness
- **Rate limiting required** - text updates fire rapidly, need 100ms+ delay to prevent spam
- **Keyboard auto-focus** - `UIScreenBase_Show_Postfix` sets EventSystem selection to first button

## Git Commit Conventions
- **Use semicolons for multiple changes** - Format: `"Change 1; Change 2; Change 3"` instead of multiline commits
- Keep commits concise and on a single line

## Do NOT
- ❌ Create compile-time dependencies on game types (IL2CPP types change)
- ❌ Patch `OnPointerEnter` for main UI (use `OnSelect` for keyboard users)
- ❌ Use `MelonLoader.MelonLogger` in SRAL.cs (it's a pure P/Invoke wrapper)
- ❌ Modify SRAL.cs unless updating SRAL library version
- ❌ Hard-code game paths (use script parameters)
- ❌ Edit `.csproj` references manually (use `update-references.ps1`)
- ❌ Use multiline commit messages (use semicolons instead)
